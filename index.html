<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Catalyst: Resume Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .stage-card { min-height: 400px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .disabled-overlay { pointer-events: none; opacity: 0.5; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6 border-b-4 border-blue-500 pb-2">
            Career Catalyst
        </h1>
        <p class="text-gray-600 mb-8">
            Optimize your resume with AI-driven critiques and quantified improvements.
        </p>

        <!-- Stage Navigation -->
        <div id="stage-nav" class="flex space-x-2 text-sm text-gray-500 mb-6">
            <span id="nav-1" class="font-bold text-blue-600">Stage 1: Critique</span>
            <span>&raquo;</span>
            <span id="nav-2">Stage 2: Interrogate</span>
            <span>&raquo;</span>
            <span id="nav-3">Stage 3: Optimize & Download</span>
        </div>
        
        <!-- User ID Display (Crucial for multi-user context) -->
        <div class="text-xs font-mono text-gray-500 mb-4 p-2 bg-gray-100 rounded-lg">
            User ID: <span id="user-id-display">Loading...</span> | Auth Status: <span id="auth-status-display" class="text-red-500">Connecting...</span>
        </div>

        <!-- Stage Containers -->
        <div id="stage-1-critique" class="stage-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 fade-in">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Paste Your Resume</h2>
            <textarea id="resume-input" class="w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-150" placeholder="Paste your resume text here. For best results, focus on the professional experience section."></textarea>
            
            <div id="s1-message" class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg hidden"></div>
            
            <button onclick="window.startCritique()" id="critique-button" class="w-full mt-4 py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <div id="s1-loading" class="spinner hidden mr-2"></div>
                Get AI Critique & Questions
            </button>
        </div>

        <div id="stage-2-interrogation" class="stage-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-6 hidden fade-in">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Answer the AI's Questions</h2>
            <div id="critique-summary" class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                <p class="font-bold text-blue-800 mb-2">Critique Summary:</p>
                <p id="critique-text" class="text-blue-700 italic"></p>
            </div>
            
            <p class="mb-4 text-gray-600">The AI needs specific, quantifiable results to rewrite your experience. Answer these questions based on measurable impact you had in each role.</p>
            
            <div id="question-list">
                <!-- Questions will be rendered here -->
            </div>

            <div id="s2-message" class="mt-4 p-3 bg-red-100 text-red-800 rounded-lg hidden"></div>

            <button onclick="window.remediateAndPreview()" id="remediate-button" class="w-full mt-6 py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <div id="s2-loading" class="spinner hidden mr-2"></div>
                Generate Optimized Resume Preview
            </button>
        </div>
        
        <div id="stage-3-download" class="stage-card bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-6 hidden fade-in">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">3. Final Review & Download</h2>
            
            <div id="resume-preview-container" class="border border-gray-300 p-6 rounded-lg bg-gray-50 mb-6 max-h-96 overflow-y-auto">
                <p class="font-bold text-lg text-gray-800 mb-2">Optimized Resume Preview</p>
                <div id="resume-preview">
                    <!-- Final optimized content will be rendered here -->
                </div>
            </div>
            
            <div id="s3-message" class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg hidden"></div>

            <p class="text-gray-600 mb-4">You have reviewed your optimized resume. Click below to claim your free beta download.</p>

            <button onclick="window.purchaseComplete()" id="download-button" class="w-full mt-4 py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                <div id="s3-loading" class="spinner hidden mr-2"></div>
                Claim Free Final Document (POC)
            </button>
        </div>

    </div>

    <!-- Firebase Script (Imported as a module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- GLOBAL APP STATE (Managed by the module scope) ---
        let app = null;
        let auth = null;
        window.userId = null; 
        window.isAuthReady = false; 

        const API_ENDPOINT = "https://your-api-gateway-url/prod/process"; // Placeholder - Replace with actual URL

        // --- CORE UTILITIES ---

        function updateStatus(status, message, type = 'info', stage = 1) {
            const el = document.getElementById(`s${stage}-message`);
            if (el) {
                el.textContent = message;
                el.className = `mt-4 p-3 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
                el.classList.remove('hidden');
            }
        }

        function setLoading(stage, isLoading) {
            const button = document.getElementById(
                stage === 1 ? 'critique-button' : 
                stage === 2 ? 'remediate-button' : 
                'download-button'
            );
            const spinner = document.getElementById(`s${stage}-loading`);
            
            if (button && spinner) {
                button.disabled = isLoading || !window.isAuthReady;
                spinner.classList.toggle('hidden', !isLoading);
                button.innerHTML = isLoading 
                    ? `<div class="spinner mr-2"></div> ${stage === 1 ? 'Critiquing...' : stage === 2 ? 'Optimizing...' : 'Processing...'}`
                    : (stage === 1 ? 'Get AI Critique & Questions' : stage === 2 ? 'Generate Optimized Resume Preview' : 'Claim Free Final Document (POC)');
            }
        }

        /**
         * @description The CORE function for all backend calls. It ensures the User ID is present.
         * @param {string} action The Lambda action name.
         * @param {object} body The request payload.
         * @returns {Promise<object>} The JSON response body.
         */
        window.apiCall = async (action, body) => {
            if (!window.userId) {
                // This is the critical gate check that solves the second error.
                // It ensures Firebase auth has completed before sending the request.
                throw new Error("API call failed: User ID is not available (Authentication pending or failed).");
            }

            const payload = { action, ...body };

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CRITICAL: Pass the authenticated user ID to the backend
                    'X-User-Id': window.userId 
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json();
            
            if (!response.ok) {
                const errorMessage = data.message || `API call failed with status: ${response.status}`;
                throw new Error(errorMessage);
            }
            return data;
        };

        // --- FIREBASE INITIALIZATION & AUTHENTICATION (FIXED) ---
        
        window.setupFirebase = () => {
            try {
                // 1. Load config safely (FIX for 'projectId' not provided)
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    console.error("Firebase Initialization Failed: '__firebase_config' is missing or malformed.");
                    document.getElementById('auth-status-display').textContent = 'Config Error';
                    return;
                }

                // 2. Initialize App
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // 3. Set up Auth State Listener (CRITICAL for timing)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User successfully signed in or session restored
                        window.userId = user.uid;
                        window.isAuthReady = true;
                        document.getElementById('user-id-display').textContent = user.uid;
                        document.getElementById('auth-status-display').textContent = 'Connected';
                        document.getElementById('auth-status-display').className = 'text-green-600';
                        document.getElementById('critique-button').disabled = false; // Enable button now that auth is ready
                        console.log(`Firebase Auth Ready. User ID: ${window.userId}`);
                    } else {
                        // User signed out, or initial sign-in attempt failed.
                        window.userId = null;
                        document.getElementById('auth-status-display').textContent = 'Attempting Sign In...';

                        // 4. Perform initial sign-in based on available token
                        try {
                            if (authToken) {
                                await signInWithCustomToken(auth, authToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Firebase Sign-In Failed:", e);
                            document.getElementById('auth-status-display').textContent = 'Sign In Failed';
                            document.getElementById('auth-status-display').className = 'text-red-500';
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                document.getElementById('auth-status-display').textContent = 'Init Error';
            }
        };

        // --- STAGE LOGIC ---

        function navigateToStage(stage) {
            document.querySelectorAll('[id^="stage-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`stage-${stage}-critique`).classList.remove('hidden');
            
            document.querySelectorAll('[id^="nav-"]').forEach(el => el.classList.remove('font-bold', 'text-blue-600'));
            document.getElementById(`nav-${stage}`).classList.add('font-bold', 'text-blue-600');
            
            if (stage === 2) document.getElementById('stage-2-interrogation').classList.remove('hidden');
            if (stage === 3) document.getElementById('stage-3-download').classList.remove('hidden');
        }

        function renderQuestions(roles) {
            const list = document.getElementById('question-list');
            list.innerHTML = ''; // Clear previous content

            JSON.parse(roles).forEach((role, roleIndex) => {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'mb-6 p-4 border border-gray-200 rounded-lg';
                roleDiv.innerHTML = `<p class="font-semibold text-lg text-gray-700 mb-3">${role.title} at ${role.company}</p>`;
                
                role.role_questions.forEach((question, qIndex) => {
                    const id = `answer-${roleIndex}-${qIndex}`;
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'mb-4';
                    inputGroup.innerHTML = `
                        <label for="${id}" class="block text-sm font-medium text-gray-700 mb-1">${qIndex + 1}. ${question}</label>
                        <textarea id="${id}" data-role="${role.title}" data-company="${role.company}" class="w-full p-3 border border-gray-300 rounded-lg focus:border-indigo-500" rows="2" placeholder="Your quantifiable achievement/answer"></textarea>
                    `;
                    roleDiv.appendChild(inputGroup);
                });
                list.appendChild(roleDiv);
            });
            
            document.getElementById('remediate-button').disabled = false;
        }

        function renderPreview(previewContentJsonString) {
            const data = JSON.parse(previewContentJsonString);
            const previewEl = document.getElementById('resume-preview');
            previewEl.innerHTML = '';
            
            // Name and Contact
            previewEl.innerHTML += `<div class="text-center mb-4 border-b pb-2"><h3 class="text-2xl font-bold">${data.name}</h3><p class="text-sm text-gray-600">${data.contact}</p></div>`;

            // Summary
            previewEl.innerHTML += `<div class="mb-4"><p class="font-bold text-gray-700 uppercase tracking-wider text-sm">Summary</p><p class="text-sm">${data.summary}</p></div>`;

            // Experience
            previewEl.innerHTML += `<div class="mb-4"><p class="font-bold text-gray-700 uppercase tracking-wider text-sm border-b-2 mt-4 pb-1">Experience</p></div>`;
            
            data.experience.forEach(role => {
                let roleHtml = `<div class="mb-4">
                    <p class="font-semibold text-base">${role.title}</p>
                    <p class="text-sm italic text-gray-600">${role.company} | ${role.years}</p>
                    <ul class="list-disc ml-5 text-sm mt-1 space-y-1">`;
                role.bullets.forEach(bullet => {
                    roleHtml += `<li>${bullet}</li>`;
                });
                roleHtml += `</ul></div>`;
                previewEl.innerHTML += roleHtml;
            });
        }
        
        window.startCritique = async () => {
            setLoading(1, true);
            document.getElementById('s1-message').classList.add('hidden');
            const resumeText = document.getElementById('resume-input').value;

            if (resumeText.length < 50) {
                updateStatus('error', 'Please paste at least 50 characters of resume text to get a meaningful critique.', 'error', 1);
                setLoading(1, false);
                return;
            }

            try {
                const response = await window.apiCall('upload_and_critique', { resumeText });
                
                // Populate Stage 2 data
                document.getElementById('critique-text').innerHTML = response.summary_critique;
                renderQuestions(JSON.stringify(response.roles)); // Pass the JSON string of roles
                
                updateStatus('success', `Critique complete! Vocation identified as: ${response.vocation}. Please proceed to Stage 2.`, 'success', 1);
                
                // Navigate to Stage 2
                navigateToStage(2);

            } catch (error) {
                console.error("Critique initiation failed:", error);
                updateStatus('error', `Critique initiation failed: ${error.message}`, 'error', 1);
            } finally {
                setLoading(1, false);
            }
        };

        window.remediateAndPreview = async () => {
            setLoading(2, true);
            document.getElementById('s2-message').classList.add('hidden');
            
            const answerElements = document.querySelectorAll('#question-list textarea');
            const userAnswers = [];
            
            // Collect answers and validate
            let allAnswered = true;
            answerElements.forEach(el => {
                if (el.value.trim() === '') {
                    allAnswered = false;
                }
                userAnswers.push({
                    role: el.getAttribute('data-role'),
                    company: el.getAttribute('data-company'),
                    user_response: el.value.trim()
                });
            });

            if (!allAnswered) {
                updateStatus('error', 'Please answer all of the AI\'s questions to generate an optimized preview.', 'error', 2);
                setLoading(2, false);
                return;
            }

            try {
                // userAnswers must be a JSON string when sent in the body
                const response = await window.apiCall('remediate_and_preview', { userAnswers: JSON.stringify(userAnswers) });
                
                renderPreview(response.preview_content);
                
                updateStatus('success', 'Preview generated! Review the optimized document and proceed to Stage 3.', 'success', 2);
                
                // Navigate to Stage 3
                navigateToStage(3);

            } catch (error) {
                console.error("Remediation failed:", error);
                updateStatus('error', `Remediation failed: ${error.message}`, 'error', 2);
            } finally {
                setLoading(2, false);
            }
        };

        window.purchaseComplete = async () => {
            setLoading(3, true);
            document.getElementById('s3-message').classList.add('hidden');

            try {
                const response = await window.apiCall('purchase_complete', {});

                if (response.status === 'LIMIT_EXCEEDED') {
                     updateStatus('error', response.message, 'error', 3);
                } else if (response.status === 'SUCCESS') {
                    // Final content is already rendered, just show the success message
                    updateStatus('success', `Download successful! Your final document has been secured. Content ID: ${window.userId}`, 'success', 3);
                }

            } catch (error) {
                console.error("Download failed:", error);
                updateStatus('error', `Download failed: ${error.message}`, 'error', 3);
            } finally {
                setLoading(3, false);
            }
        };

        // --- Start the application ---
        window.onload = () => {
            window.setupFirebase();
            // Initial navigation is handled by the default HTML structure (Stage 1 is visible)
        };

    </script>
</body>
</html>
